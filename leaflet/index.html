<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

   <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <title>Leaflet</title>

  <style>
        #map { height: 700px; border: thin solid grey; }
        .js-tab-top {
            padding: 1em;
            border-radius: 10px 10px 0 0;
            display: inline-block;
            background-color: #e6f2ff;
        }

        .active, .js-tab {
            background-color: #f2f2f2;
        }

        .js-tab {
            padding: 1em;
        }
        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }
        #river-table {
            border-collapse: collapse;
            width: 100%;
            background-color: #ffffff;
        }

        #river-table td, #river-table th {
            padding: 0.5em;
            border-bottom: 1px solid #595959;
            text-align: left;
        }

        #river-readings {
            display: none;
        }

        .clickable, .js-link {
            cursor: pointer;
        }

        .js-link {
            text-decoration: underline;
            color: blue;
        }
    </style>  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>   
</head>

<body>

<div class="container-fluid">
  
    <div id="map"></div>

    <script type="text/javascript">
        var map = L.map( 'map', {
            center: [57.172, -4.6582],
            minZoom: 2,
            zoom: 7
        });
        
        L.tileLayer( 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo( map );

        var emptyIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/EMPTY.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/EMPTY.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var scrapeIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/SCRAPE.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/SCRAPE.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var lowIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/LOW.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/LOW.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var mediumIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/MEDIUM.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/MEDIUM.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var highIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/HIGH.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/HIGH.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var veryHighIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/VERY_HIGH.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/VERY_HIGH.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var hugeIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/HUGE.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/HUGE.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var oldDataIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/OLD_DATA.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/OLD_DATA.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var noDataIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/NO_GUAGE_DATA.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/NO_GUAGE_DATA.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        var needsCalibrationsIcon = L.icon({
            iconUrl: 'http://canoescotland.org/wheres-the-water/pics/NEEDS_CALIBRATIONS.png',
            iconRetinaUrl: 'http://canoescotland.org/wheres-the-water/pics/NEEDS_CALIBRATIONS.png',
            iconSize: [10, 10],
            iconAnchor: [0, 0],
            popupAnchor: [5, -3]
        });
        
        var riverSections;
        var riverSectionsFile = $.getJSON("../data/river-sections.json", function(data) {
                console.log('section' + data[0]['name']);
                riverSections = data;
            }
        );
        var riverReadings;
        var riverReadingsFile = $.getJSON("../data/rivers-readings.json", function(data) {
                console.log('river reading' + data["234189"]["currentReading"]);
                riverReadings = data;
            }
        );
        var bothFiles = $.when(riverSectionsFile, riverReadingsFile);

        bothFiles.done(function () {
            mergeRiverData();
            addRiverMarkers();
        });
        
        function mergeRiverData() {
            for (i=0; i<riverSections.length; i++) {
                console.log('merging: ' + riverSections[i]['name']);
                try {
                    var gauge_location_code = riverSections[i]['gauge_location_code']
                    riverSections[i]['currentReading'] = riverReadings[gauge_location_code]['currentReading'];
                    riverSections[i]['trend'] = riverReadings[gauge_location_code]['trend'];
                    riverSections[i]['currentReadingTime'] = riverReadings[gauge_location_code]['currentReadingTime'];
                } catch(error) {
                    console.log('Error on merging ' + riverSections[i]['name'] + ' ' + error.message);
                }
            }
        }
        function addRiverMarkers() {
            console.log('TODO addRiverMarkers()');
            for (i=0; i<riverSections.length; i++) {
                var riverSection = riverSections[i]['name'];
                var currentReading = riverSections[i]['currentReading'];
                var waterLevelValue = getWaterLevelValue(riverSections[i]);
                var iconBase = 'http://canoescotland.org/wheres-the-water/pics/';
                var ext = '.png';
                var trend = riverSections[i]['trend'];
                var currentReadingTime = riverSections[i]['currentReadingTime'];
                var sectionLinks = riverSections[i]['guidebook_link'];
                var riverReadings = getRiverReadingsTable(riverSections[i], waterLevelValue);
                var riverFilename = getRiverGraphFilename(riverSections[i]);
                var icon = getWaterLevelIcon(riverSections[i]);
                var contentString = "<div><p><b>" + riverSection + "</b></p><p>Level: " + currentReading + " (" + waterLevelValue + 
                    ") <img src='" + iconBase + waterLevelValue + ext + "' /></p><p>Trend: " + trend + "</p><p>Last reading: " + currentReadingTime +
                    "</p><p>" + sectionLinks + "</p>" +
                    "<p><span class='js-calib-table'>Calibrations</span> / <span class='js-chart link' style='text-decoration: underline; color: blue; cursor: pointer'>Level chart</span></p>" + riverReadings + "<p class='js-chart-content' style='display: none'>" +
                    "<a href='/wheres-the-water/charts/"+riverFilename+"-weekly.png'>"+
                    "<img src='http://canoescotland.org/wheres-the-water/charts/"+riverFilename+"-weekly.png' style='max-width: 250px; width: 100%' /></a></p>" +
                    "</div>";
                L.marker([riverSections[i]['latitude'], riverSections[i]['longitude']], {icon: icon}).bindPopup(contentString).addTo( map );
            }
        }
        function getWaterLevelValue(riverSection) {
            currentReading = riverSection['currentReading'];
            if (currentReading < riverSection['scrape_value']) {
                return "EMPTY";
            } else if (currentReading < riverSection['low_value']) {
                return "SCRAPE";
            } else if (currentReading < riverSection['medium_value']) {
                return "LOW";
            } else if (currentReading < riverSection['high_value']) {
                return "MEDIUM";
            } else if (currentReading < riverSection['very_high_value']) {
                return "HIGH";
            } else if (currentReading < riverSection['huge_value']) {
                return "VERY_HIGH";
            } else {
                return "HUGE";
            }
        }
        function getRiverReadingsTable(riverSection, waterLevelValue) {

            var boxColors = ['#e6e6e6', '#e6e6e6', '#e6e6e6', '#e6e6e6', '#e6e6e6', '#e6e6e6', '#e6e6e6'];
            switch(waterLevelValue) {
                case 'HUGE':
                    boxColors[0] = '#ffffff';
                    break;
                case 'VERY_HIGH':
                    boxColors[1] = '#ffffff';
                    break;
                case 'HIGH':
                    boxColors[2] = '#ffffff';
                    break;
                case 'MEDIUM':
                    boxColors[3] = '#ffffff';
                    break;
                case 'LOW':
                    boxColors[4] = '#ffffff';
                    break;
                case 'SCRAPE':
                    boxColors[5] = '#ffffff';
                    break;
                case 'EMPTY':
                    boxColors[6] = '#ffffff';
                    break;
            }
            var riverReadings = '<table class="js-calib-table-content" style="background-color: #424242">' +
                            '<tbody>' +
                                '<tr>' +
                                    '<td style="background-color: #FF0000">Huge</td>' +
                                    '<td style="background-color: ' + boxColors[0] + '">> ' + riverSection['huge_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #FF6060">Very High</td>' +
                                    '<td style="background-color: ' + boxColors[1] + '">' + riverSection['very_high_value'] + ' - ' + riverSection['huge_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #FFC004">High</td>' +
                                    '<td style="background-color: ' + boxColors[2] + '">' + riverSection['high_value'] + ' - ' + riverSection['very_high_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #FFFF33">Medium</td>' +
                                    '<td style="background-color: ' + boxColors[3] + '">' + riverSection['medium_value'] + ' - ' + riverSection['high_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #00FF00">Low</td>' +
                                    '<td style="background-color: ' + boxColors[4] + '">' + riverSection['low_value'] + ' - ' + riverSection['medium_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #CCFFCC">Scrapeable</td>' +
                                    '<td style="background-color: ' + boxColors[5] + '">' + riverSection['scrape_value'] + ' - ' + riverSection['low_value'] + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                    '<td style="background-color: #CCCCCC">Empty</td>' +
                                    '<td style="background-color: ' + boxColors[6] + '">< ' + riverSection['scrape_value'] + '</td>' +
                                '</tr>' +
                            '</tbody>' +
                        '</table>';
            return riverReadings
        }
        function getRiverGraphFilename(riverSection) {
            var riverFilename = riverSection['name'].toLowerCase();
            riverFilename = riverFilename.replace(/ /g, '-');
            riverFilename = riverFilename.replace(/\(/g, '');
            riverFilename = riverFilename.replace(/\)/g, '');
            return riverFilename
        }
        function getWaterLevelIcon(riverSection) {
            currentReading = riverSection['currentReading'];
            if (currentReading < riverSection['scrape_value']) {
                return emptyIcon;
            } else if (currentReading < riverSection['low_value']) {
                return scrapeIcon;
            } else if (currentReading < riverSection['medium_value']) {
                return lowIcon;
            } else if (currentReading < riverSection['high_value']) {
                return mediumIcon;
            } else if (currentReading < riverSection['very_high_value']) {
                return highIcon;
            } else if (currentReading < riverSection['huge_value']) {
                return veryHighIcon;
            } else {
                return hugeIcon;
            }
        }

        jQuery(document).ready( function(){
            jQuery('#map').on('click', '.js-calib-table', function(){
                    if (!jQuery(this).hasClass('js-link')){
                        jQuery('.js-chart-content').hide();
                        jQuery('.js-calib-table-content').show();
                        jQuery(this).attr('style', '');
                        jQuery('.js-chart').attr('style', 'text-decoration: underline; color: blue; cursor: pointer');
                    }
                });
                jQuery('#map').on('click', '.js-chart', function(){
                    if (!jQuery(this).hasClass('js-link')){
                        jQuery('.js-calib-table-content').hide();
                        jQuery('.js-chart-content').show();
                        jQuery(this).attr('style', '');
                        jQuery('.js-calib-table').attr('style', 'text-decoration: underline; color: blue; cursor: pointer');
                    }
                });
        });
  </script>

</div>

</body>
</html>
